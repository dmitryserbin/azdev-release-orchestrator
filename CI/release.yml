trigger:
  branches:
    include:
    - master
  paths:
    include:
    - Tasks/*

parameters:
- name: publishPreview
  displayName: Publish preview
  type: boolean
  default: true
- name: testV1
  displayName: Test V1
  type: boolean
  default: true
- name: testV2
  displayName: Test V2
  type: boolean
  default: true
- name: testV3
  displayName: Test V3
  type: boolean
  default: true

stages:
- stage: Build
  jobs:
  - template: templates/build.yml
    parameters:
      taskV1: true
      taskV2: true
      taskV3: true
      extension: true

- stage: Preview
  dependsOn:
  - Build
  jobs:
  - template: templates/preview.yml
    parameters:
      publish: ${{ parameters.publishPreview }}
      testV1: ${{ parameters.testV1 }}
      testV2: ${{ parameters.testV2 }}
      testV3: ${{ parameters.testV3 }}
      cleanup: false

- stage: Release
  dependsOn:
  - Build
  - Preview
  jobs:
  - template: templates/release.yml
    parameters:
      environmentName: Marketplace
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/master'))
