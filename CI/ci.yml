trigger: none

pr:
  branches:
    include:
    - master
  paths:
    include:
    - Tasks/*
  autoCancel: true

parameters:
- name: publishTask
  displayName: Publish task artifact
  type: boolean
  default: false
- name: publishExtension
  displayName: Publish extension artifact
  type: boolean
  default: false

variables:
- template: templates/variables.yml

jobs:
- job: OrchestratorV1
  pool:
    name: Default
  workspace:
    clean: all
  steps:
  - template: templates/build.yml
    parameters:
      name: ${{ variables.taskNameV1 }}
      path: ${{ variables.taskPathV1 }}
      restore: true
      build: true
      test: true
      publish: ${{ parameters.publishTask }}

- job: OrchestratorV2
  pool:
    name: Default
  workspace:
    clean: all
  steps:
  - template: templates/build.yml
    parameters:
      name: ${{ variables.taskNameV2 }}
      path: ${{ variables.taskPathV2 }}
      restore: true
      lint: true
      build: true
      test: true
      publish: ${{ parameters.publishTask }}

- job: Extension
  pool:
    name: Default
  workspace:
    clean: all
  dependsOn:
  - OrchestratorV1
  - OrchestratorV2
  steps:
  - template: templates/package.yml
    parameters:
      path: ${{ variables.artifactsPath }}
      contents: |
        Images/**
        LICENSE
        *.md
        *.json
      version: ${{ variables.extensionVersion }}
      publish: ${{ parameters.publishExtension }}
